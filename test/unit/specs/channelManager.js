/* globals describe, it, spyOn, require, beforeEach, expect, jasmine */

describe('ChannelManager ===', function() {
  'use strict';

  var XJS = require('xjs');
  var Channel = XJS.Channel;
  var ChannelManager = XJS.ChannelManager;
  var env = new window.Environment(XJS);
  var environments = ['props', 'extension', 'plugin'];
  var xjsEnvironment = XJS.Environment;

  describe('should be able to listen to stream events', function() {
    it('such as stream start', function(done) {
      ChannelManager.on('stream-start', function(eventObj) {
        expect(eventObj['error']).toBeTypeOf('boolean');
        expect(eventObj['channel']).toBeTypeOf('object');
        expect(eventObj['channel']).hasMethods('getStreamDrops, getStreamTime, ' +
            'getName, getStreamRenderedFrames');
        expect(eventObj['streamTime']).toBeTypeOf('undefined');
        done();
      });
      window.SetEvent('event=StreamStart&info=%7B%22ChannelName%22%3A%22Local%20Streaming%22%2C%22Settings%22%3A%22%3Cchannel%20serviceName%3D%5C%22LocalStreaming%5C%22%20name%3D%5C%22Local%20Streaming%5C%22%20displayName%3D%5C%22Local%20Streaming%5C%22%20description%3D%5C%22%5C%22%20rtmpUrl%3D%5C%22rtmp%3A%2F%2F192.168.254.179%3A1935%2Fapp%5C%22%20streamName%3D%5C%22stream%5C%22%20link%3D%5C%22http%3A%2F%2Fdemo.splitmedialabs.com%2FVHJavaMediaSDK3%2Fview.html%3Fid%3Dstream%26amp%3Burl%3Drtmp%3A%2F%2F192.168.254.179%3A1935%2Fapp%26amp%3Bbuffer%3D1%26amp%3BforceObjectEncoding%3D0%5C%22%20username%3D%5C%22%5C%22%20password%3D%5C%22%5C%22%20channel%3D%5C%22%5C%22%20extraConfig%3D%5C%22%5C%5Crtmp_2ch%3A1%5C%5Crtmp_buf%3A65536%5C%5Crtmp_timeout_media%3A0%5C%5Crtmp_timeout_close%3A500%5C%5ClowLatency%3A0%5C%5ChasSupportedResolutionsOnly%3A0%5C%5ChasSupportedFpsOnly%3A0%5C%5Crtmp_flashver%3AXSplit%2F2.8%5C%5Corigabitrate%3A96000%5C%5Crtmp_timeout_connect%3A0%5C%5Crtmp_h264optm%3A0%5C%5Crtmp_h264optq%3A2000%5C%5Copt_faststart%3A1%5C%5Copt_segconv%3A0%5C%5Copt_remuxto%3Amp4%26amp%3Bmovflags%3Afrag_keyframe%2Bempty_moov%26amp%3Bfrag_size%3A16777216%5C%22%20recordBroadcast%3D%5C%221%5C%22%20filetype%3D%5C%22flv%5C%22%20file%3D%5C%22mp4%3AC%3A%5C%5CUsers%5C%5Cmeso%5C%5CDownloads%5C%5Cchanasafasfasfasfasfasfasfaszxnmvxchbtihbx%2C.cmnbvfjnbklvnbkl%3Bdfjhgdrengvzx%2C.nv%3Bk%20%20%20%20%20%20ldsg%5C%5CLocal%20Streaming%5C%5C2016-04-07_20-57-00.mp4%5C%22%20enableoutwatermark%3D%5C%220%5C%22%3E%3Cconfiguration%3E%3Cvideo%20codec%3D%5C%22libx264ext64%26amp%3Bex%3Apreset%3Averyfast%26amp%3Bex%3Acrf%3A27%26amp%3Bex%3Avbv-bufsize%3A1000%26amp%3Bex%3Avbv-maxrate%3A1000%26amp%3Bex%3Akeyint%3A60%26amp%3Bex%3Afps%3A10000000%2F333333%5C%22%20framerate%3D%5C%22333333%5C%22%20x264Presets%3D%5C%22%26amp%3Bveryfast%5C%22%20quality%3D%5C%2227%5C%22%20codecCommands%3D%5C%22ex%3Afps%3A10000000%2F333333%5C%22%20cbr%3D%5C%220%5C%22%20adaptivebr%3D%5C%220%5C%22%20keyint%3D%5C%222%5C%22%20bufferSize%3D%5C%221000k%5C%22%20maxBitrate%3D%5C%221000k%5C%22%20resizeex%3D%5C%220%5C%22%20dontUseDefaultMixerResolution%3D%5C%220%5C%22%20dontUseDefaultMixerFPS%3D%5C%220%5C%22%20frametimemodereset%3D%5C%2210000000%5C%22%20%2F%3E%3Caudio%20bitrate%3D%5C%2296000%5C%22%20codec%3D%5C%22libw7aac%26amp%3Bb%3A96000%5C%22%20format%3D%5C%2244100%2F2%5C%22%20format2%3D%5C%2244100%2F2%5C%22%20%2F%3E%3C%2Fconfiguration%3E%3Cextra%3E%3Cparams%20%2F%3E%3Cspeex%20vbr%3D%5C%220%5C%22%20q%3D%5C%2210%5C%22%20vmrq%3D%5C%2210%5C%22%20vbrmax%3D%5C%2242200%5C%22%20abr%3D%5C%2242200%5C%22%20complexity%3D%5C%224%5C%22%20vad%3D%5C%220%5C%22%20dtx%3D%5C%220%5C%22%20hp%3D%5C%221%5C%22%20%2F%3E%3C%2Fextra%3E%3Chotkey%3E%3CHotKey%20name%3D%5C%22Broadcaster_ToggleBroadcast_Local%20Streaming%5C%22%20desc%3D%5C%22Start%2Fstop%20Local%20Streaming%20broadcast%5C%22%20keyCode%3D%5C%22None%5C%22%20%2F%3E%3C%2Fhotkey%3E%3Cmeta%3E%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22aid%5C%22%20value%3D%5C%22QRUEBm2Cfk4xSVehwhf%2B0d68Go%2B0wzKmYq9bduaZGUg%3D%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22bufferSize%5C%22%20value%3D%5C%221000k%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22maxBitrate%5C%22%20value%3D%5C%221000k%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22videodevice%5C%22%20value%3D%5C%22XSplitBroadcaster%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitBroadcasterVersion%5C%22%20value%3D%5C%221.4.1604.603%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitCoreVersion%5C%22%20value%3D%5C%222.8.1604.0701%20Version%202.8%20Beta%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitGameSourceVersion%5C%22%20value%3D%5C%221.1.1603.901%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitMediaLibVersion%5C%22%20value%3D%5C%222.0.1604.601%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%220%5C%22%20name%3D%5C%22framerate%5C%22%20value%3D%5C%2230%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22pluginName%5C%22%20value%3D%5C%22LocalStreaming%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22pluginVersion%5C%22%20value%3D%5C%222.8.1604.0101%5C%22%20%2F%3E%5Cr%5Cn%3C%2Fmeta%3E%3C%2Fchannel%3E%22%2C%22Dropped%22%3A0%2C%22NotDropped%22%3A0%2C%22StreamTime%22%3Anull%7D');
    });

    it('and stream end', function(done) {
      ChannelManager.on('stream-end', function(eventObj) {
        expect(eventObj['error']).toBeTypeOf('boolean');
        expect(eventObj['channel']).toBeTypeOf('object');
        expect(eventObj['channel']).hasMethods('getStreamDrops, getStreamTime, ' +
            'getName, getStreamRenderedFrames');
        expect(eventObj['streamTime']).toBeTypeOf('number');
        done();
      });
      window.SetEvent('event=StreamEnd&info=%7B%22ChannelName%22%3A%22Local%20Streaming%22%2C%22Settings%22%3A%22%3Cchannel%20serviceName%3D%5C%22LocalStreaming%5C%22%20name%3D%5C%22Local%20Streaming%5C%22%20displayName%3D%5C%22Local%20Streaming%5C%22%20description%3D%5C%22%5C%22%20rtmpUrl%3D%5C%22rtmp%3A%2F%2F192.168.254.179%3A1935%2Fapp%5C%22%20streamName%3D%5C%22stream%5C%22%20link%3D%5C%22http%3A%2F%2Fdemo.splitmedialabs.com%2FVHJavaMediaSDK3%2Fview.html%3Fid%3Dstream%26amp%3Burl%3Drtmp%3A%2F%2F192.168.254.179%3A1935%2Fapp%26amp%3Bbuffer%3D1%26amp%3BforceObjectEncoding%3D0%5C%22%20username%3D%5C%22%5C%22%20password%3D%5C%22%5C%22%20channel%3D%5C%22%5C%22%20extraConfig%3D%5C%22%5C%5Crtmp_2ch%3A1%5C%5Crtmp_buf%3A65536%5C%5Crtmp_timeout_media%3A0%5C%5Crtmp_timeout_close%3A500%5C%5ClowLatency%3A0%5C%5ChasSupportedResolutionsOnly%3A0%5C%5ChasSupportedFpsOnly%3A0%5C%5Crtmp_flashver%3AXSplit%2F2.8%5C%5Corigabitrate%3A96000%5C%5Crtmp_timeout_connect%3A0%5C%5Crtmp_h264optm%3A0%5C%5Crtmp_h264optq%3A2000%5C%5Copt_faststart%3A1%5C%5Copt_segconv%3A0%5C%5Copt_remuxto%3Amp4%26amp%3Bmovflags%3Afrag_keyframe%2Bempty_moov%26amp%3Bfrag_size%3A16777216%5C%22%20recordBroadcast%3D%5C%221%5C%22%20filetype%3D%5C%22flv%5C%22%20file%3D%5C%22mp4%3AC%3A%5C%5CUsers%5C%5Cmeso%5C%5CDownloads%5C%5Cchanasafasfasfasfasfasfasfaszxnmvxchbtihbx%2C.cmnbvfjnbklvnbkl%3Bdfjhgdrengvzx%2C.nv%3Bk%20%20%20%20%20%20ldsg%5C%5CLocal%20Streaming%5C%5C2016-04-07_20-57-00.mp4%5C%22%20enableoutwatermark%3D%5C%220%5C%22%3E%3Cconfiguration%3E%3Cvideo%20codec%3D%5C%22libx264ext64%26amp%3Bex%3Apreset%3Averyfast%26amp%3Bex%3Acrf%3A27%26amp%3Bex%3Avbv-bufsize%3A1000%26amp%3Bex%3Avbv-maxrate%3A1000%26amp%3Bex%3Akeyint%3A60%26amp%3Bex%3Afps%3A10000000%2F333333%5C%22%20framerate%3D%5C%22333333%5C%22%20x264Presets%3D%5C%22%26amp%3Bveryfast%5C%22%20quality%3D%5C%2227%5C%22%20codecCommands%3D%5C%22ex%3Afps%3A10000000%2F333333%5C%22%20cbr%3D%5C%220%5C%22%20adaptivebr%3D%5C%220%5C%22%20keyint%3D%5C%222%5C%22%20bufferSize%3D%5C%221000k%5C%22%20maxBitrate%3D%5C%221000k%5C%22%20resizeex%3D%5C%220%5C%22%20dontUseDefaultMixerResolution%3D%5C%220%5C%22%20dontUseDefaultMixerFPS%3D%5C%220%5C%22%20frametimemodereset%3D%5C%2210000000%5C%22%20%2F%3E%3Caudio%20bitrate%3D%5C%2296000%5C%22%20codec%3D%5C%22libw7aac%26amp%3Bb%3A96000%5C%22%20format%3D%5C%2244100%2F2%5C%22%20format2%3D%5C%2244100%2F2%5C%22%20%2F%3E%3C%2Fconfiguration%3E%3Cextra%3E%3Cparams%20%2F%3E%3Cspeex%20vbr%3D%5C%220%5C%22%20q%3D%5C%2210%5C%22%20vmrq%3D%5C%2210%5C%22%20vbrmax%3D%5C%2242200%5C%22%20abr%3D%5C%2242200%5C%22%20complexity%3D%5C%224%5C%22%20vad%3D%5C%220%5C%22%20dtx%3D%5C%220%5C%22%20hp%3D%5C%221%5C%22%20%2F%3E%3C%2Fextra%3E%3Chotkey%3E%3CHotKey%20name%3D%5C%22Broadcaster_ToggleBroadcast_Local%20Streaming%5C%22%20desc%3D%5C%22Start%2Fstop%20Local%20Streaming%20broadcast%5C%22%20keyCode%3D%5C%22None%5C%22%20%2F%3E%3C%2Fhotkey%3E%3Cmeta%3E%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22aid%5C%22%20value%3D%5C%22QRUEBm2Cfk4xSVehwhf%2B0d68Go%2B0wzKmYq9bduaZGUg%3D%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22bufferSize%5C%22%20value%3D%5C%221000k%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22maxBitrate%5C%22%20value%3D%5C%221000k%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22videodevice%5C%22%20value%3D%5C%22XSplitBroadcaster%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitBroadcasterVersion%5C%22%20value%3D%5C%221.4.1604.603%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitCoreVersion%5C%22%20value%3D%5C%222.8.1604.0701%20Version%202.8%20Beta%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitGameSourceVersion%5C%22%20value%3D%5C%221.1.1603.901%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitMediaLibVersion%5C%22%20value%3D%5C%222.0.1604.601%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%220%5C%22%20name%3D%5C%22framerate%5C%22%20value%3D%5C%2230%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22pluginName%5C%22%20value%3D%5C%22LocalStreaming%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22pluginVersion%5C%22%20value%3D%5C%222.8.1604.0101%5C%22%20%2F%3E%5Cr%5Cn%3C%2Fmeta%3E%3C%2Fchannel%3E%22%2C%22Dropped%22%3A10%2C%22NotDropped%22%3A77048%2C%22StreamTime%22%3A54500%7D');
    });

    it('and always return stream time as a number', function(done) {
      ChannelManager.on('stream-end', function(eventObj) {
        expect(eventObj['streamTime']).toBeTypeOf('number');
        done();
      });
      window.SetEvent('event=StreamEnd&info=%7B%22ChannelName%22%3A%22Local%20Streaming%22%2C%22Settings%22%3A%22%3Cchannel%20serviceName%3D%5C%22LocalStreaming%5C%22%20name%3D%5C%22Local%20Streaming%5C%22%20displayName%3D%5C%22Local%20Streaming%5C%22%20description%3D%5C%22%5C%22%20rtmpUrl%3D%5C%22rtmp%3A%2F%2F192.168.254.179%3A1935%2Fapp%5C%22%20streamName%3D%5C%22stream%5C%22%20link%3D%5C%22http%3A%2F%2Fdemo.splitmedialabs.com%2FVHJavaMediaSDK3%2Fview.html%3Fid%3Dstream%26amp%3Burl%3Drtmp%3A%2F%2F192.168.254.179%3A1935%2Fapp%26amp%3Bbuffer%3D1%26amp%3BforceObjectEncoding%3D0%5C%22%20username%3D%5C%22%5C%22%20password%3D%5C%22%5C%22%20channel%3D%5C%22%5C%22%20extraConfig%3D%5C%22%5C%5Crtmp_2ch%3A1%5C%5Crtmp_buf%3A65536%5C%5Crtmp_timeout_media%3A0%5C%5Crtmp_timeout_close%3A500%5C%5ClowLatency%3A0%5C%5ChasSupportedResolutionsOnly%3A0%5C%5ChasSupportedFpsOnly%3A0%5C%5Crtmp_flashver%3AXSplit%2F2.8%5C%5Corigabitrate%3A96000%5C%5Crtmp_timeout_connect%3A0%5C%5Crtmp_h264optm%3A0%5C%5Crtmp_h264optq%3A2000%5C%5Copt_faststart%3A1%5C%5Copt_segconv%3A0%5C%5Copt_remuxto%3Amp4%26amp%3Bmovflags%3Afrag_keyframe%2Bempty_moov%26amp%3Bfrag_size%3A16777216%5C%22%20recordBroadcast%3D%5C%221%5C%22%20filetype%3D%5C%22flv%5C%22%20file%3D%5C%22mp4%3AC%3A%5C%5CUsers%5C%5Cmeso%5C%5CDownloads%5C%5Cchanasafasfasfasfasfasfasfaszxnmvxchbtihbx%2C.cmnbvfjnbklvnbkl%3Bdfjhgdrengvzx%2C.nv%3Bk%20%20%20%20%20%20ldsg%5C%5CLocal%20Streaming%5C%5C2016-04-07_20-57-00.mp4%5C%22%20enableoutwatermark%3D%5C%220%5C%22%3E%3Cconfiguration%3E%3Cvideo%20codec%3D%5C%22libx264ext64%26amp%3Bex%3Apreset%3Averyfast%26amp%3Bex%3Acrf%3A27%26amp%3Bex%3Avbv-bufsize%3A1000%26amp%3Bex%3Avbv-maxrate%3A1000%26amp%3Bex%3Akeyint%3A60%26amp%3Bex%3Afps%3A10000000%2F333333%5C%22%20framerate%3D%5C%22333333%5C%22%20x264Presets%3D%5C%22%26amp%3Bveryfast%5C%22%20quality%3D%5C%2227%5C%22%20codecCommands%3D%5C%22ex%3Afps%3A10000000%2F333333%5C%22%20cbr%3D%5C%220%5C%22%20adaptivebr%3D%5C%220%5C%22%20keyint%3D%5C%222%5C%22%20bufferSize%3D%5C%221000k%5C%22%20maxBitrate%3D%5C%221000k%5C%22%20resizeex%3D%5C%220%5C%22%20dontUseDefaultMixerResolution%3D%5C%220%5C%22%20dontUseDefaultMixerFPS%3D%5C%220%5C%22%20frametimemodereset%3D%5C%2210000000%5C%22%20%2F%3E%3Caudio%20bitrate%3D%5C%2296000%5C%22%20codec%3D%5C%22libw7aac%26amp%3Bb%3A96000%5C%22%20format%3D%5C%2244100%2F2%5C%22%20format2%3D%5C%2244100%2F2%5C%22%20%2F%3E%3C%2Fconfiguration%3E%3Cextra%3E%3Cparams%20%2F%3E%3Cspeex%20vbr%3D%5C%220%5C%22%20q%3D%5C%2210%5C%22%20vmrq%3D%5C%2210%5C%22%20vbrmax%3D%5C%2242200%5C%22%20abr%3D%5C%2242200%5C%22%20complexity%3D%5C%224%5C%22%20vad%3D%5C%220%5C%22%20dtx%3D%5C%220%5C%22%20hp%3D%5C%221%5C%22%20%2F%3E%3C%2Fextra%3E%3Chotkey%3E%3CHotKey%20name%3D%5C%22Broadcaster_ToggleBroadcast_Local%20Streaming%5C%22%20desc%3D%5C%22Start%2Fstop%20Local%20Streaming%20broadcast%5C%22%20keyCode%3D%5C%22None%5C%22%20%2F%3E%3C%2Fhotkey%3E%3Cmeta%3E%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22aid%5C%22%20value%3D%5C%22QRUEBm2Cfk4xSVehwhf%2B0d68Go%2B0wzKmYq9bduaZGUg%3D%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22bufferSize%5C%22%20value%3D%5C%221000k%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22maxBitrate%5C%22%20value%3D%5C%221000k%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22videodevice%5C%22%20value%3D%5C%22XSplitBroadcaster%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitBroadcasterVersion%5C%22%20value%3D%5C%221.4.1604.603%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitCoreVersion%5C%22%20value%3D%5C%222.8.1604.0701%20Version%202.8%20Beta%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitGameSourceVersion%5C%22%20value%3D%5C%221.1.1603.901%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22xsplitMediaLibVersion%5C%22%20value%3D%5C%222.0.1604.601%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%220%5C%22%20name%3D%5C%22framerate%5C%22%20value%3D%5C%2230%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22pluginName%5C%22%20value%3D%5C%22LocalStreaming%5C%22%20%2F%3E%5Cr%5Cn%3Cvalue%20type%3D%5C%222%5C%22%20name%3D%5C%22pluginVersion%5C%22%20value%3D%5C%222.8.1604.0101%5C%22%20%2F%3E%5Cr%5Cn%3C%2Fmeta%3E%3C%2Fchannel%3E%22%2C%22Dropped%22%3A10%2C%22NotDropped%22%3A77048%2C%22StreamTime%22%3Anull%7D');
    });
  });

  describe('should show a warning', function() {
    beforeEach(function() {
      spyOn(console, 'warn').and.callThrough();
    });

    it('when used on source config window', function() {
      env.set(environments[0]);
      ChannelManager.on('stream-end', function(eventObj) {
      });
      expect(console.warn).toHaveBeenCalled();
      env.set(environments[1]);
    });
  });

});
